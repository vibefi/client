<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Wry + EIP-1193 Provider</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    pre { background: #f6f6f6; padding: 12px; border-radius: 12px; overflow: auto; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #ddd; margin-right: 8px; }
  </style>
</head>
<body>
  <h1>Wry + EIP-1193 Provider</h1>
  <p>Open the developer console to see provider logs. This page calls window.ethereum.request.</p>

  <div>
    <button id="btn-connect">eth_requestAccounts</button>
    <button id="btn-chain">eth_chainId</button>
    <button id="btn-sign">personal_sign</button>
    <button id="btn-typed">eth_signTypedData_v4</button>
  </div>

  <h3>Output</h3>
  <pre id="out"></pre>

  <script>
    const out = document.getElementById('out');
    function log(x) {
      out.textContent += (typeof x === 'string' ? x : JSON.stringify(x, null, 2)) + "\n";
    }

    async function run(label, fn) {
      try {
        log('> ' + label);
        const res = await fn();
        log(res);
      } catch (e) {
        log({ error: String(e && e.message ? e.message : e) });
      }
      log('');
    }

    function ensure() {
      if (!window.ethereum) {
        log('window.ethereum is not injected');
        throw new Error('No ethereum provider');
      }
      if (!window.ethereum.request) {
        log('window.ethereum.request is missing');
        throw new Error('No request()');
      }
    }

    document.getElementById('btn-connect').onclick = () => run('eth_requestAccounts', async () => {
      ensure();
      return await window.ethereum.request({ method: 'eth_requestAccounts', params: [] });
    });

    document.getElementById('btn-chain').onclick = () => run('eth_chainId', async () => {
      ensure();
      return await window.ethereum.request({ method: 'eth_chainId', params: [] });
    });

    document.getElementById('btn-sign').onclick = () => run('personal_sign', async () => {
      ensure();
      const msg = 'Hello from Wry';
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts', params: [] });
      return await window.ethereum.request({ method: 'personal_sign', params: [msg, accounts[0]] });
    });

    document.getElementById('btn-typed').onclick = () => run('eth_signTypedData_v4', async () => {
      ensure();
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts', params: [] });
      const from = accounts[0];
      const typed = {
        types: {
          EIP712Domain: [
            { name: 'name', type: 'string' },
            { name: 'version', type: 'string' },
            { name: 'chainId', type: 'uint256' },
            { name: 'verifyingContract', type: 'address' }
          ],
          Mail: [
            { name: 'from', type: 'address' },
            { name: 'to', type: 'address' },
            { name: 'contents', type: 'string' }
          ]
        },
        primaryType: 'Mail',
        domain: {
          name: 'Wry Demo',
          version: '1',
          chainId: 1,
          verifyingContract: '0x0000000000000000000000000000000000000000'
        },
        message: {
          from,
          to: '0x0000000000000000000000000000000000000001',
          contents: 'Hello, EIP-712!'
        }
      };
      return await window.ethereum.request({ method: 'eth_signTypedData_v4', params: [from, JSON.stringify(typed)] });
    });

    if (window.ethereum && window.ethereum.on) {
      window.ethereum.on('accountsChanged', (accs) => log({ event: 'accountsChanged', accs }));
      window.ethereum.on('chainChanged', (cid) => log({ event: 'chainChanged', cid }));
      window.ethereum.on('connect', (info) => log({ event: 'connect', info }));
    }
  </script>
</body>
</html>
