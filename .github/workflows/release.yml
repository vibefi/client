name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: release-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
  cancel-in-progress: false

env:
  CARGO_PACKAGER_VERSION: "0.11.8"
  VIBEFI_EMBED_WC_PROJECT_ID: ${{ secrets.VIBEFI_WC_PROJECT_ID }}

jobs:
  prepare:
    name: Resolve Release Metadata
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.meta.outputs.release_tag }}
      release_version: ${{ steps.meta.outputs.release_version }}
      release_ref: ${{ steps.meta.outputs.release_ref }}
      release_sha: ${{ steps.meta.outputs.release_sha }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Resolve and validate release metadata
      id: meta
      shell: bash
      run: |
        set -euo pipefail

        TAG="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}"
        if [[ ! "$TAG" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
          echo "Error: release tag must match vX.Y.Z, got: $TAG"
          exit 1
        fi

        git fetch --tags --force
        if ! git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
          echo "Error: tag does not exist in repository: $TAG"
          exit 1
        fi

        SHA="$(git rev-list -n 1 "refs/tags/$TAG")"
        VERSION="${TAG#v}"
        REF="refs/tags/$TAG"

        echo "release_tag=$TAG" >> "$GITHUB_OUTPUT"
        echo "release_version=$VERSION" >> "$GITHUB_OUTPUT"
        echo "release_ref=$REF" >> "$GITHUB_OUTPUT"
        echo "release_sha=$SHA" >> "$GITHUB_OUTPUT"

        echo "Resolved release metadata:"
        echo "  tag: $TAG"
        echo "  version: $VERSION"
        echo "  ref: $REF"
        echo "  sha: $SHA"

  build-macos:
    name: Build macOS (${{ matrix.target }})
    runs-on: macos-latest
    needs: prepare
    strategy:
      matrix:
        target:
          - aarch64-apple-darwin
          - x86_64-apple-darwin

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.prepare.outputs.release_ref }}

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install cargo-binstall
      uses: cargo-bins/cargo-binstall@main

    - name: Cache cargo-packager binary
      id: cache-cargo-packager
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-packager
        key: cargo-packager-${{ runner.os }}-${{ env.CARGO_PACKAGER_VERSION }}

    - name: Install Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install cargo-packager
      if: steps.cache-cargo-packager.outputs.cache-hit != 'true'
      run: cargo binstall --no-confirm cargo-packager@${{ env.CARGO_PACKAGER_VERSION }}

    - name: Verify cargo-packager
      run: cargo packager --version

    - name: Fetch Bun binaries for packaging
      run: ./vendor/fetch-bun.sh

    - name: Set package version from release tag
      run: bun packaging/cargo-version.mjs set "${{ needs.prepare.outputs.release_version }}"

    - name: Build release binary
      run: cargo build --release --target ${{ matrix.target }}

    - name: Package application
      run: |
        cargo packager --release \
          --target ${{ matrix.target }} \
          --formats app,dmg

    - name: List packaged outputs
      run: ls -lRh target/packager/

    - name: Determine arch label
      id: arch
      run: |
        case "${{ matrix.target }}" in
          aarch64-*) echo "label=aarch64" >> "$GITHUB_OUTPUT" ;;
          x86_64-*)  echo "label=x64"     >> "$GITHUB_OUTPUT" ;;
        esac

    - name: Prepare artifacts
      run: |
        set -euo pipefail
        shopt -s nullglob
        mkdir -p artifacts
        dmg_files=(target/packager/*.dmg)
        if [ ${#dmg_files[@]} -eq 0 ]; then
          echo "Error: No DMG files found in target/packager/"
          exit 1
        fi
        cp "${dmg_files[@]}" artifacts/
        echo "DMG files copied successfully"

        cd target/packager
        found_app=false
        for app in *.app; do
          if [ -d "$app" ]; then
            base="${app%.app}"
            tar -czf "../../artifacts/${base}_${{ steps.arch.outputs.label }}.app.tar.gz" "$app"
            echo "Archived $app as ${base}_${{ steps.arch.outputs.label }}.app.tar.gz"
            found_app=true
          fi
        done
        if [ "$found_app" = false ]; then
          echo "Error: No .app bundles found in target/packager/"
          exit 1
        fi
        cd ../..

        if [ "${{ matrix.target }}" = "aarch64-apple-darwin" ]; then
          cp packaging/macos/install-vibefi-macos.sh artifacts/install-vibefi-macos.sh
        fi

        app_archives=(artifacts/*_${{ steps.arch.outputs.label }}.app.tar.gz)
        if [ ${#app_archives[@]} -eq 0 ]; then
          echo "Error: No archived .app bundle produced for arch ${{ steps.arch.outputs.label }}"
          exit 1
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vibefi-macos-${{ matrix.target }}
        path: artifacts/*
        if-no-files-found: error
        retention-days: 7

  build-linux:
    name: Build Linux (x86_64)
    runs-on: ubuntu-22.04
    needs: prepare

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.prepare.outputs.release_ref }}

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-binstall
      uses: cargo-bins/cargo-binstall@main

    - name: Cache cargo-packager binary
      id: cache-cargo-packager
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-packager
        key: cargo-packager-${{ runner.os }}-${{ env.CARGO_PACKAGER_VERSION }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libwebkit2gtk-4.1-dev \
          libayatana-appindicator3-dev

    - name: Install Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install cargo-packager
      if: steps.cache-cargo-packager.outputs.cache-hit != 'true'
      run: cargo binstall --no-confirm cargo-packager@${{ env.CARGO_PACKAGER_VERSION }}

    - name: Verify cargo-packager
      run: cargo packager --version

    - name: Fetch Bun binaries for packaging
      run: ./vendor/fetch-bun.sh

    - name: Set package version from release tag
      run: bun packaging/cargo-version.mjs set "${{ needs.prepare.outputs.release_version }}"

    - name: Build release binary
      run: cargo build --release

    - name: Package application
      run: |
        cargo packager --release \
          --formats deb,appimage

    - name: Patch AppImage for portability
      run: |
        APPIMAGE=$(find target/packager -name '*.AppImage' -type f | head -1)
        if [ -n "$APPIMAGE" ]; then
          bash packaging/linux/patch-appimage.sh "$APPIMAGE"
        else
          echo "Error: No AppImage found to patch"
          exit 1
        fi

    - name: List packaged outputs
      run: ls -lRh target/packager/

    - name: Prepare artifacts
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p artifacts
        cp target/packager/*.deb artifacts/
        cp target/packager/*.AppImage artifacts/
        ls -l artifacts

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vibefi-linux-x86_64
        path: artifacts/*
        if-no-files-found: error
        retention-days: 7

  build-windows:
    name: Build Windows (x86_64)
    runs-on: windows-latest
    needs: prepare

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.prepare.outputs.release_ref }}

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-binstall
      uses: cargo-bins/cargo-binstall@main

    - name: Cache cargo-packager binary
      id: cache-cargo-packager
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-packager.exe
        key: cargo-packager-${{ runner.os }}-${{ env.CARGO_PACKAGER_VERSION }}

    - name: Install Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install cargo-packager
      if: steps.cache-cargo-packager.outputs.cache-hit != 'true'
      run: cargo binstall --no-confirm cargo-packager@${{ env.CARGO_PACKAGER_VERSION }}

    - name: Verify cargo-packager
      run: cargo packager --version

    - name: Fetch Bun binaries for packaging
      shell: pwsh
      run: .\vendor\fetch-bun.ps1

    - name: Prepare Bun binary for MSVC target
      shell: pwsh
      run: Copy-Item -Path .\vendor\bun\bun-x86_64-pc-windows-gnu.exe -Destination .\vendor\bun\bun-x86_64-pc-windows-msvc.exe -Force

    - name: Set package version from release tag
      run: bun packaging/cargo-version.mjs set "${{ needs.prepare.outputs.release_version }}"

    - name: Build release binary
      run: cargo build --release

    - name: Package application
      run: cargo packager --release --formats nsis

    - name: List packaged outputs
      shell: pwsh
      run: Get-ChildItem -Recurse .\target\packager\ | Format-List FullName, Length

    - name: Prepare artifacts
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path artifacts -Force | Out-Null
        Copy-Item -Path .\target\packager\*.exe -Destination .\artifacts\
        Get-ChildItem .\artifacts\ | Format-List FullName, Length

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vibefi-windows-x86_64
        path: artifacts/*
        if-no-files-found: error
        retention-days: 7

  publish:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build-macos
      - build-linux
      - build-windows

    steps:
    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: vibefi-*
        merge-multiple: true
        path: release-artifacts

    - name: List release artifacts
      shell: bash
      run: |
        set -euo pipefail
        ls -lRh release-artifacts

    - name: Upload assets to release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.prepare.outputs.release_tag }}
        target_commitish: ${{ needs.prepare.outputs.release_sha }}
        files: release-artifacts/*
        fail_on_unmatched_files: true
